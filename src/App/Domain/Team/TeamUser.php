<?phpnamespace App\Domain\Team;use function App\addLog;use App\Auth\Domain\User;use App\Common\CommonDomain;use App\Common\Exception\WrongRequestException;use function App\getCurrentUser;use function App\nowTime;/** * 团队成员类 * * @author lws */class TeamUser extends CommonDomain{    private static $Model = null;    public function __construct()    {        if (self::$Model == null) {            self::$Model = new \App\Model\Team\TeamUser();        }    }    public function getTeamUser($param)    {        if (!is_array($param)) {            $param = get_object_vars($param);        }        if (!isset($param['team_id']) or !$param['team_id']) {            $domain_team = new Team();            $current_user = getCurrentUser();            $team_list = $domain_team->getUserTeam($current_user['id']);            if ($team_list) {                $param['team_id'] = $team_list[0]['team_id'];            }else{                return array('list' => array(), 'count' => 0);            }        }        $offset = ($param['page_num'] - 1) * $param['page_size'];        $order = (!isset($param['order']) or $param['order'] == '') ? '' : ' ORDER BY ' . $param['order'];        $key_word = (!isset($param['keyWord']) or $param['keyWord'] == '' )? ' WHERE 1=1 ' :  ' WHERE ( u.nick_name like '. "'%"  . $param['keyWord'] . "%' OR u.nick_name like " . "'%" . $param['keyWord'] . "%' )";        $prefix = \PhalApi\DI()->config->get('dbs.tables.__default__.prefix');        $sql = 'SELECT *,u.id as u_user_id,u.id as id '            . 'FROM ' . $prefix . 'team_user AS tu '            . 'JOIN ' . $prefix . 'user AS u '            . ' ON tu.user_id = u.id '            . 'JOIN ' . $prefix . 'user_level AS l '            . ' ON u.level_id = l.id '            . 'JOIN ' . $prefix . 'user_position AS p '            . ' ON u.position_id = p.id '            . $key_word            . ' AND tu.team_id = :id ';        $params = array(':id' => $param['team_id']);        $lists = \PhalApi\DI()->notorm->notTable->queryRows($sql, $params);        $count = count($lists);        $sql .= $order.' LIMIT ' . $offset . ',' . $param['page_size'];        $lists = \PhalApi\DI()->notorm->notTable->queryRows($sql, $params);        $list = array('list' => $lists, 'count' => $count);        return $list;    }    public function getList($param)    {        if (!is_array($param)) {            $param = get_object_vars($param);        }        if (isset($param['keyWord'])) {        }        $list = self::$Model->getList($param);        return $list;    }    public function getInfo($where,$field = '*')    {        return self::$Model->getInfo($where,$field);    }    /** 删除团队成员     * @param $id id     * @param $team_id     * @return int     */    public function delTeamUser($id,$team_id)    {        $model_team = new \App\Model\Team\Team();        $model_user = new \App\Model\User\User();        $team_info = $model_team->get($team_id,'leader_id,team_name');        $user_info = $model_user->get($id,'realname');        $result = self::$Model->delTeamUser($id,$team_id);        if ($result) {            if($team_info['leader_id'] == $id){                $result = $model_team->update($team_id,array('leader_id'=>0));            }            addLog("将 {$user_info['realname']} 从 {$team_info['team_name']} 移除");        }        return $result == true ? 0 : 1;    }    /**     *  新增团队成员     * @param $data     * @return bool     * @throws WrongRequestException     */    public function addTeamUser($data)    {        $user = self::$Model->getInfo($data,'id');        if (!$user) {            $data['join_time'] = nowTime();            $id = self::$Model->insert($data);            if ($id === false) {                throw new WrongRequestException('新增失败', 8);            }        }        $user_model = new \App\Model\User\User();        $team_model = new \App\Model\Team\Team();        $user_info = $user_model->get($data['user_id'],'realname');        $team_info = $team_model->get($data['team_id'],'team_name');        addLog("{$user_info['realname']} 加入了 {$team_info['team_name']}");    }    public function editTeamUser($id,$data)    {        $result = self::$Model->update($id,$data);        if ($result === false) {            throw new WrongRequestException('保存失败', 6);        }            addLog('修改团队成员，评级ID：' . $id);    }}