<?phpnamespace App\Domain\Common;use function App\addLog;use App\Common\CommonDomain;use App\Common\Exception\WrongRequestException;use App\Model\Project\Project;use App\Model\Project\Task;use App\Model\Project\TaskUser;use App\Model\User\User;use function App\nowTime;/** * 全局搜索类 * * @author lws */class Search extends CommonDomain{    public function __construct()    {    }    public function search($param)    {        if (!is_array($param)) {            $param = get_object_vars($param);        }        $model_project = new Project();        $model_task  = new Task();        if (isset($param['keyWord'])) {            $param['where']["name LIKE ? or project_desc LIKE ? "] = array("%" . $param['keyWord'] . "%","%" . $param['keyWord'] . "%");//            $param['where']['deleted'] = '0';        }        $param['order'] = 'p.id desc';        $project_list = $model_project->getList($param);        if (isset($param['keyWord'])) {//            $param['where']["title LIKE ? or content LIKE ? "] = array("%" . $param['keyWord'] . "%","%" . $param['keyWord'] . "%");            $param['where']["name LIKE ? "] = array("%" . $param['keyWord'] . "%");        }        $current_user = \App\getCurrentUser();        $param['user_id'] = $current_user['id'];        $param['order'] = 't.id desc';        $task_list = $this->getTaskForUser($param);        $list = array();        $list[]['title'] = '项目';        $list[]['title'] = '任务';        $list[0]['children'] = array();        $list[1]['children'] = array();        if ($project_list['list']) {            foreach ($project_list['list'] as $key=>$item) {                if ($key > 4) {                    break;                }                $list[0]['children'][$key]['title'] = $item['name'];                $list[0]['children'][$key]['id'] = $item['project_id'];            }        }        if ($task_list['list']) {            foreach ($task_list['list'] as $key=>$item) {                if ($key > 4) {                    break;                }                $list[1]['children'][$key]['title'] = $item['name'];                $list[1]['children'][$key]['id'] = $item['task_id'];            }        }        return $list;    }    public function getTaskForUser($param)    {        if (!is_array($param)) {            $param = get_object_vars($param);        }        $order = $param['order'] == '' ? '' : ' ORDER BY ' . $param['order'];        $key_word = $param['keyWord'] == '' ? ' WHERE 1=1 ' :  ' WHERE ( t.name like '. "'%"  . $param['keyWord'] . "%' OR t.desc like " . "'%" . $param['keyWord'] . "%' )";        $prefix = \PhalApi\DI()->config->get('dbs.tables.__default__.prefix');        $params = array(':user_id' => $param['user_id']);        $sql = 'SELECT *,t.id as t_id '            . 'FROM ' . $prefix . 'task AS t '            . 'JOIN ' . $prefix . 'task_user AS tu '            . 'ON t.id = tu.task_id '            . $key_word            .' AND tu.user_id = :user_id and t.deleted = "0" and status !="closed"';//        if($param['state'] != -1){//            $sql .= 'AND t.task_state = :task_state ';//            $params[':task_state'] = $param['state'];//        }//        if ($param['is_executor']) {//            $sql .= 'AND tu.is_executor = 1 ';//        }//        if ($param['is_creator']) {//            $sql .= 'AND t.create_user_id = :create_user_id ';//            $params[':create_user_id'] = $param['user_id'];//        }//        if ($param['project_id']) {//            $sql .= 'AND t.project_id = :project_id ';//            $params[':project_id'] = $param['project_id'];//        }//        if ($param['is_overdue']) {//            $sql .= 'AND t.end_time < :end_time AND t.end_time is not null';//            $params[':end_time'] = nowTime();//        }        $sql .= $order;        $lists = \PhalApi\DI()->notorm->notTable->queryRows($sql, $params);        $count = count($lists);        $list = array('list' => $lists, 'count' => $count);        return $list;    }}