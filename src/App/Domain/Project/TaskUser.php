<?phpnamespace App\Domain\Project;use function App\addTaskLog;use App\Common\CommonDomain;use App\Common\Exception\WrongRequestException;use function App\getCurrentUser;use App\Model\User\User;use function App\nowTime;use PhalApi\Exception\BadRequestException;/** * 任务成员类 * * @author lws */class TaskUser extends CommonDomain{    private static $Model = null;    public function __construct()    {        if (self::$Model == null) {            self::$Model = new \App\Model\Project\TaskUser();        }    }    /**获取成员列表     * @param $param     * @return array 数据对象     */    public function getList($param)    {        if (!is_array($param)) {            $param = get_object_vars($param);        }        if (isset($param['keyWord'])) {            $param['where']["content LIKE ? or id = ? "] = array("%" . $param['keyWord'] . "%", $param['keyWord']);        }        $param['where']['task_id'] = $param['task_id'];        $list = self::$Model->getList($param);        $executor = array();        if ($list['list']) {            $model_user = new User();            foreach ($list['list'] as &$item) {                if ($item) {                    $user = $model_user->get($item['user_id']);                    $item['user_info'] = $user;                    if ($item['is_executor']) {                        $executor = $user;                    }                }            }            unset($item);        }        $list['executor'] = $executor;        return $list;    }    /**     * 添加任务成员     * @param $task_id     * @param $user_id     * @throws \PhalApi\Exception\BadRequestException     */    public function addTaskUser($task_id,$user_id)    {        $data = array('task_id' => $task_id, 'user_id' => $user_id);        $task_user_info = self::$Model->getInfo($data);        $modal_user = new User();        $user_info = $modal_user->get($user_id,'realname,id');        $log_data = array();        $log_data['log_type'] = "add_member";        $current_user = getCurrentUser();        if (!$task_user_info) {            $task_user_info = self::$Model->getInfo(array('task_id'=>$task_id));            if (!$task_user_info) {                $data['is_executor'] = 1;            }            $data['create_time'] = nowTime();            $result = self::$Model->insert($data);            if ($result) {                $to_user_id = $user_id;                $log_data['user_id'] = $current_user['id'];                if (!$task_user_info and $user_id == $current_user['id']) {                    $to_user_id = 0;                    $content = "加入并认领了任务";                }else{                    if ($current_user['id'] != $user_id) {                        $content = "邀请 {$user_info['realname']} 加入任务";                    }else{                        $content = "加入任务";                        $to_user_id = 0;                    }                }                addTaskLog($content,$task_id,$log_data['log_type'],'','',0,$to_user_id);            }        }else{            if (!$task_user_info['is_executor']) {                self::$Model->delete($task_user_info['id']);                $log_data['task_id'] = $task_id;                if ($current_user['id'] != $user_id) {                    $log_data['content'] = "将 {$user_info['realname']} 从任务中移除";                }else{                    $log_data['content'] = "退出了任务";                }                $log_data['log_type'] = "remove_user";                addTaskLog($log_data['content'],$log_data['task_id'],$log_data['log_type'],'','',$user_info['id']);            }        }    }    /**     * @param $task_id     * @param $user_id     * @throws BadRequestException     */    public function addTaskExecutorUser($task_id, $user_id)    {        $this_user_info = getCurrentUser();        $this_user_id = $this_user_info['id'];        $modal_user = new User();        $user_info = $modal_user->get($user_id,'realname,account,id');        $log_data = array();        $model_task_user = new \App\Model\Project\TaskUser();        $task_user_info = $model_task_user->getInfo(array('user_id'=>$user_id,'task_id'=>$task_id));        try {            if (!$task_user_info) {                //todo 如果一开始任务无人                $this->addTaskUser($task_id,$user_id);                $task_user_info = $model_task_user->getInfo(array('user_id'=>$user_id,'task_id'=>$task_id));            }            if ($task_user_info) {                if (!$task_user_info['is_executor']) {                    \PhalApi\DI()->notorm->beginTransaction(DB_TICKET);                    $result = $model_task_user->updateByWhere(array('is_executor'=>1,'task_id'=>$task_id),array('is_executor'=>0));                    if ($result === false) {                        throw new WrongRequestException('操作失败', 2);                    }                    $result = $model_task_user->update($task_user_info['id'],array('is_executor'=>1));                    if ($result === false) {                        throw new WrongRequestException('操作失败', 3);                    }                    $log_data['task_id'] = $task_id;                    if ($this_user_id == $user_id) {                        $log_data['content'] = "认领了任务";                    }else{                        $log_data['content'] = "指派给了 {$user_info['realname']}";                    }                    $log_data['log_type'] = "add_executor";                    $model_task = new \App\Model\Project\Task();                    $model_task->update($task_id,array('assignedTo'=>$user_info['account']));                    addTaskLog($log_data['content'],$log_data['task_id'],$log_data['log_type'],'','',$this_user_id,$user_info['id']);                    \PhalApi\DI()->notorm->commit(DB_TICKET);                }            }        } catch (WrongRequestException $exception) {            \PhalApi\DI()->notorm->rollback(DB_TICKET);        }    }    public function deleteTaskUser($task_id)    {        return self::$Model->deleteByWhere(array('task_id'=>$task_id));    }}