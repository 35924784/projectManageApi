<?phpnamespace App\Domain\Project;use App\Common\CommonDomain;use App\Domain\Common\Notify;use App\Model\User\User;use function App\nowTime;/** * 项目日志类 * * @author lws */class Log extends CommonDomain{    private static $Model = null;    public function __construct()    {        if (self::$Model == null) {            self::$Model = new \App\Model\Project\Log();        }    }    /**获取日志列表     * @param $param     * @return array 数据对象     */    public function getList($param)    {        if (!is_array($param)) {            $param = get_object_vars($param);        }        if (isset($param['keyWord'])) {            $param['where']["content LIKE ? or id = ? "] = array("%" . $param['keyWord'] . "%",$param['keyWord']);        }        if (isset($param['project_id'])) {            $param['where']["project_id"] = $param['project_id'];        }        if (isset($param['search_date']) and count($param['search_date']) > 0) {            $param['where']["create_time >= ? "] = $param['search_date'][0];            $param['where']["create_time <= ? "] = date('Y-m-d H:i:s', strtotime($param['search_date'][1]) + 24 * 3600);        }        $list = self::$Model->getList($param);        if ($list['list']) {            $model_user = new User();            foreach ($list['list'] as &$item) {                if ($item) {                    $user = $model_user->get($item['user_id'], 'realname,avatar');                    $item['user_name'] = $user['realname'];                    $item['user_avatar'] = $user['avatar'];                }            }            unset($item);        }        if ($param['contain_task_log']) {            $model_task_log = new \App\Model\Project\TaskLog();            $model_task = new \App\Model\Project\Task();            $task_ids = $model_task->getListByWhere(array('project' => $param['project_id']),'id');            $task_log_list = $model_task_log->getListByIds($task_ids,'task_id');            $new_task_list = array();            if ($task_log_list) {                $model_user = new User();                foreach ($task_log_list as $key=>$item) {                    if ($item['log_type'] == 'add' or $item['log_type'] == 'done' or $item['log_type'] == 'again'                        or $item['log_type'] == 'upload') {                        $task_info = $model_task->get($item['task_id'], 'name');                        $item['task_title'] = $task_info['name'];                        $user = $model_user->get($item['user_id'], 'realname,avatar');                        $item['user_name'] = $user['realname'];                        $item['user_avatar'] = $user['avatar'];                        $new_task_list[] = $item;                    }                }            }            $list['list'] = array_merge($list['list'], $new_task_list);            $temp = null;            if ($list['list']) {                $count = count($list['list']) - 1;                for ($i = 1; $i <= $count; $i++) {                    for ($j = 0; $j <= ($count - 1); $j++) {                        if($list['list'][$j]['create_time'] < $list['list'][$j + 1]['create_time']) {                            $temp = $list['list'][$j + 1];                            $list['list'][$j + 1] = $list['list'][$j];                            $list['list'][$j] = $temp;                        }                    }                }            }            $list['count'] += count($new_task_list);        }        return $list;    }    public static function addLog($content,$project_id = 0, $user_id = 0,$ticket = '')    {        $param = array();        $param['content'] = $content;        $param['project_id'] = $project_id;        $param['user_id'] = $user_id;        $param['ticket'] = $ticket;        $param['create_time'] = nowTime();        $model = new \App\Model\Project\Log();        $domain_notify = new Notify();        $domain_notify->NotifyHook('project',$param,2);        return $model->insert($param);    }}